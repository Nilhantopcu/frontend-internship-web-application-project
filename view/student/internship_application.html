<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Application</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <link href="/public/css/internship_application.css" rel="stylesheet">
    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
    <!-- TOP Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <img src="/public/image/logo.png" alt="logo" class="logo-default"
                    style="width: 270px; margin: 5px 0 5px 0;">
            </div>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <img src="/public/image/user.png" class="rounded-circle" height="25" alt="User Avatar"
                        loading="lazy" style="transform: scale(2.5); margin-right: 15px;">
                </div>
            </div>
        </div>
    </nav>

    <!-- Secondary Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #b5e0ff;">
        <a class="navbar-brand" href="home.html" style="padding-left: 50px;">Home Page</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor03"
            aria-controls="navbarColor03" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor03">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="internship_application.html">Internship Application</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="upload_intership_application_form.html">Upload Internship Application
                        Form</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="my_internship_applications.html">My Internship Applications</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="internship_reports.html">Internship Reports</a>
                </li>
            </ul>
        </div>

        <!-- Notification and Logout -->
        <ul class="navbar-nav d-flex flex-row me-1" style="padding-right: 50px;">
            <li class="nav-item me-3 me-lg-0">
                <div class="dropdown">
                    <button type="button" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-bell" viewBox="0 0 16 16">
                            <path
                                d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6">
                            </path>
                        </svg>
                    </button>
                </div>
            </li>
            <li class="nav-item" style="padding-left: 20px;">
                <a class="nav-link" href="/view/login.html">Log Out</a>
            </li>
        </ul>
    </nav>

    <div class="container" style="margin-top: 30px;">
        <div class="card">
            <!-- Form -->
            <div class="card-header" style="color:#007bff;">
                INTERNSHIP APPLICATION FORM - STEP 1
            </div>
            <div class="container my-5">
                <form id="internshipForm">
                    <div class="row g-3">
                        <div class="col">
                            <div class="mb-3">
                                <label for="companyName" class="form-label">Company Name</label>
                                <input list="companyNames" class="form-control" id="companyName"
                                    aria-describedby="companyName">
                                <datalist id="companyNames">
                                    <!-- Dinamik olarak eklenecek -->
                                </datalist>
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label for="departmentName" class="form-label">Department Name</label>
                                <input list="departmentNames" class="form-control" id="departmentName">
                                <datalist id="departmentNames">
                                    <!-- Dinamik olarak eklenecek -->
                                </datalist>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col">
                            <div class="mb-3">
                                <label for="productionArea" class="form-label">Production/Service Area</label>
                                <input type="text" class="form-control" id="productionArea">
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label for="companyPhoneNumber" class="form-label">Company Phone Number</label>
                                <input type="text" class="form-control" id="companyPhoneNumber">
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col">
                            <div class="mb-3">
                                <label for="companyEmailAddress" class="form-label">Company Email Address</label>
                                <input type="email" class="form-control" id="companyEmailAddress">
                            </div>
                            <div class="mb-3">
                                <label for="internshipNumber" class="form-label">Internship Number</label>
                                <input list="internshipNumbers" class="form-control" id="internshipNumber"
                                    aria-describedby="internshipNumber">
                                <datalist id="internshipNumbers">
                                    <option value="First">
                                    <option value="Secondary">
                                    <option value="Volunteer">
                                        <!-- Daha fazla seçenek eklenebilir -->
                                </datalist>
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label for="companyAddress" class="form-label">Company Address</label>
                                <input type="text" class="form-control" id="companyAddress" style="height: 126px;">
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col">
                            <div class="mb-3">
                                <label for="sameDepartmentGraduate" class="form-label"><b>Is there anyone who graduated
                                        from the same department as you in the department where you will do your
                                        internship?</b></label><br>
                                <input list="sameDepartmentGraduateOptions" class="form-control"
                                    id="sameDepartmentGraduate" aria-describedby="sameDepartmentGraduate">
                                <datalist id="sameDepartmentGraduateOptions">
                                    <option value="yes">
                                    <option value="no">
                                        <!-- Daha fazla seçenek eklenebilir -->
                                </datalist>
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label for="correspondingPerson" class="form-label">Corresponding Person Name:</label>
                                <input type="text" class="form-control" id="correspondingPerson"
                                    style="margin-top: 23px;">
                            </div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col">
                            <div class="mb-3">
                                <label for="internshipDays" class="form-label">Internship Days</label>
                                <input type="text" class="form-control" id="internshipDays"
                                    placeholder="Monday, Tuesday, Wednesday, Thursday ...">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="datepicker" class="font-weight-bold">Internship Dates:</label>
                                <div class="input-group date" id="datepicker">
                                    <input type="text" class="form-control" id="dates"
                                        placeholder="Pick the multiple dates">
                                    <span class="input-group-append">
                                        <span class="input-group-text bg-white">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col">
                            <div class="form-group">
                                <label for="startDate" style="padding-bottom: 10px; font-weight: bold;">Internship Start
                                    Date:</label>
                                <div class="input-group date" id="start_datepicker">
                                    <input type="text" class="form-control" id="startDate" placeholder="dd/mm/yyyy">
                                    <span class="input-group-append">
                                        <span class="input-group-text bg-white">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="finishDate" style="padding-bottom: 10px; font-weight: bold;">Internship
                                    Finish Date:</label>
                                <div class="input-group date" id="finish_datepicker">
                                    <input type="text" class="form-control" id="finishDate" placeholder="dd/mm/yyyy">
                                    <span class="input-group-append">
                                        <span class="input-group-text bg-white">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Next</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center text-lg-start">
        <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.05);">
            2024 © FMV Işık University - Şule İlkbahar &  Nilhan Topçu
        </div>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script type="text/javascript">
        // $(function () {
        //     var minDate = new Date();
        //     minDate.setDate(minDate.getDate());

        //     $('#start_datepicker').datepicker({
        //         format: 'dd-mm-yyyy',
        //         startDate: minDate,
        //         todayHighlight: true,
        //         autoclose: true
        //     });

        //     $('#finish_datepicker').datepicker({
        //         format: 'dd-mm-yyyy',
        //         startDate: minDate,
        //         todayHighlight: true,
        //         autoclose: true
        //     });

        //     $('#datepicker').datepicker({
        //         multidate: true,
        //         format: 'dd-mm-yyyy',
        //         startDate: minDate,
        //     });
        // });


        $(function () {
            var minDate = new Date();
            minDate.setDate(minDate.getDate() + 15); // Bugünden 15 gün sonrası

            $('#start_datepicker').datepicker({
                format: 'dd/mm/yyyy',
                startDate: minDate,
                todayHighlight: true,
                autoclose: true
            }).on('changeDate', function (e) {
                var selectedDate = e.date;
                if (selectedDate < minDate) {
                    alert('En erken 15 gün sonrayı seçebilirsiniz');
                    $('#startDate').val('');
                } else {
                    $('#datepicker').datepicker('setDate', selectedDate);
                }
            });

            $('#finish_datepicker').datepicker({
                format: 'dd/mm/yyyy',
                startDate: minDate,
                todayHighlight: true,
                autoclose: true
            });

            $('#datepicker').datepicker({
                multidate: true,
                format: 'dd/mm/yyyy',
                startDate: minDate
            }).on('changeDate', function (e) {
                var dates = $(this).datepicker('getDates');
                if (dates.length > 0) {
                    var startDate = $('#startDate').datepicker('getDate');
                    if (!startDate || startDate.toDateString() !== dates[0].toDateString()) {
                        $('#startDate').datepicker('setDate', dates[0]);
                    }
                    if (dates.length === 20) {
                        $('#finishDate').datepicker('setDate', dates[19]);
                    }
                }
            });

            // Dinamik olarak company names ve department names doldurulması
            async function loadCompanyAndDepartmentNames() {
                try {
                    const companyResponse = await fetch('http://localhost:3000/company/getAll');
                    const departmentResponse = await fetch('http://localhost:3000/department/getAll');

                    if (companyResponse.ok && departmentResponse.ok) {
                        const companies = await companyResponse.json();
                        const departments = await departmentResponse.json();

                        const companyDatalist = document.getElementById('companyNames');
                        companies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.name;
                            companyDatalist.appendChild(option);
                        });

                        const departmentDatalist = document.getElementById('departmentNames');
                        departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.name;
                            departmentDatalist.appendChild(option);
                        });
                    } else {
                        console.error('Failed to fetch company or department data');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            loadCompanyAndDepartmentNames();
        });

        document.getElementById('companyName').addEventListener('input', async function () {
            const companyName = this.value;
            if (companyName) {
                try {
                    const response = await fetch(`http://localhost:3000/company/getByName?companyName=${encodeURIComponent(companyName)}`);
                    if (response.ok) {
                        const company = await response.json();
                        if (company) {
                            document.getElementById('departmentName').value = company.departmentName || '';
                            document.getElementById('productionArea').value = company.productionArea || '';
                            document.getElementById('companyPhoneNumber').value = company.companyPhoneNumber || '';
                            document.getElementById('companyEmailAddress').value = company.companyEmailAddress || '';
                            document.getElementById('companyAddress').value = company.companyAddress || '';
                        } else {
                            // Şirket bulunamadığında formu temizleyin
                            document.getElementById('departmentName').value = '';
                            document.getElementById('productionArea').value = '';
                            document.getElementById('companyPhoneNumber').value = '';
                            document.getElementById('companyEmailAddress').value = '';
                            document.getElementById('companyAddress').value = '';
                        }
                    } else {
                        console.error('Failed to fetch company data');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                // Şirket adı boş olduğunda formu temizleyin
                document.getElementById('departmentName').value = '';
                document.getElementById('productionArea').value = '';
                document.getElementById('companyPhoneNumber').value = '';
                document.getElementById('companyEmailAddress').value = '';
                document.getElementById('companyAddress').value = '';
            }
        });

        document.getElementById('internshipForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const dates = $('#datepicker').datepicker('getDates').map(date => {
                return new Date(date).toISOString().slice(0, 10); // ISO formatında kısa tarih
            });

            const sameDepartmentGraduate = document.getElementById('sameDepartmentGraduate').value;
            if (sameDepartmentGraduate.toLowerCase() === 'no') {
                alert('There must be someone who graduated from the same department as you in the department where you will do your internship.');
                return;
            }

            // Tarih sayısını kontrol ediyoruz
            if (dates.length !== 20) {
                alert('You must select exactly 20 dates.');
                return; // Form gönderimini durdur
            }

            const formData = {
                companyName: document.getElementById('companyName').value,
                departmentName: document.getElementById('departmentName').value,
                productionArea: document.getElementById('productionArea').value,
                companyPhoneNumber: document.getElementById('companyPhoneNumber').value,
                companyEmailAddress: document.getElementById('companyEmailAddress').value,
                companyAddress: document.getElementById('companyAddress').value,
                internshipNumber: document.getElementById('internshipNumber').value,
                sameDepartmentGraduate: document.getElementById('sameDepartmentGraduate').value,
                startDate: document.getElementById('startDate').value,
                finishDate: document.getElementById('finishDate').value,
                internshipDays: document.getElementById('internshipDays').value,
                correspondingPerson: document.getElementById('correspondingPerson').value,
            };

            localStorage.setItem('internshipFormData', JSON.stringify(formData));

            try {
                const response = await fetch('http://localhost:3000/internship', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken'), // Eğer token kullanıyorsanız
                    },
                    body: JSON.stringify(formData),
                });

                if (response.ok) {
                    const result = await response.json()
                    const internshipID = result.id;
                    localStorage.setItem('internshipId', internshipID);
                    alert('Internship application submitted successfully!');
                    window.location.href = '/view/student/step2.html'; // Yönlendirme işlemi burada gerçekleşir.
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    alert('Failed to submit internship application: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting the application.');
            }

            // internshipID değişkeninin değerini al
            const internshipID = localStorage.getItem('internshipId');

            // internshipID değişkeninin değerini kontrol et ve konsola yazdır
            console.log("Internship ID:", internshipID);

            // Eğer internshipID tanımlı değilse veya boşsa, fetch çağrısını yapma
            if (!internshipID) {
                console.error("Internship ID is not defined or empty.");
            } else {
                // internshipID tanımlıysa ve boş değilse fetch çağrısını yap
                try {
                    const response = await fetch(`http://localhost:3000/internship/${internshipID}/send-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('accessToken'),
                        },
                        body: JSON.stringify(formData),
                    });

                    if (response.ok) {
                        alert('Email sent successfully!');
                    } else {
                        // Handle error response
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        alert('Failed to send email: ' + (errorData.message || 'Unknown error'));
                    }
                } catch (error) {
                    // Handle network or other errors
                    console.error('Error:', error);
                    alert('An error occurred while sending the email.');
                }
            }

        });
    </script>


</body>

</html>